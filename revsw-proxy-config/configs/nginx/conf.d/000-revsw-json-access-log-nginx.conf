#
# This file is deployed via package revsw-proxy-config.
#

# Custom access log file in JSON format - BP proxy

log_format logstash_json '{'
'"@timestamp": "$time_iso8601", '
'"unixtime": $msec, '
'"@version": "1", ' 
'"conn_id": "$connection", '
'"domain": "$http_host", '
'"ipport": "$server_port", '
'"clientport": "$remote_port", '
'"protocol": "$server_protocol", '
'"clientip": "$clientip", '
'"duration": $request_time, '
'"upstream_time": "$upstream_response_time", '
'"response": "$status", '
'"request": "$request_uri", '
'"s_bytes": $bytes_sent, '
'"s_body_bytes": $body_bytes_sent, '
'"r_bytes": $request_length, '
'"method": "$request_method", '
'"conn_status": "$request_completion", '
'"KA": $connection_requests, '
'"FBT_mu": "$sent_http_x_rev_be_1st_byte_time", '
'"cache": "$sent_http_x_rev_cache", '
'"cache2": "$sent_http_x_cache", '
'"cache_age": "$sent_http_age", '
'"cache_ttl": "$sent_http_x_rev_beresp_ttl", '
'"range": "$http_range", '
'"c_range": "$sent_http_content_range", '
'"referer": "$http_referer", '
'"agent": "$http_user_agent", '
'"cont_type": "$sent_http_content_type", '
'"cont_enc": "$sent_http_content_encoding", '
'"sdk_host": "$http_x_rev_host", '
'"quic": "$http_x_rev_transport", '
'"http2": "$http2", '
# '"spdy_ver": "$spdy", '
# '"error_log_id": "-", '
'"lm_rtt": $tcpinfo_rtt, '
# '"tcpinfo_rttvar": "$tcpinfo_rttvar", '
# '"tcpinfo_snd_cwnd": "$tcpinfo_snd_cwnd", '
# '"tcpinfo_rcv_space": "$tcpinfo_rcv_space", '
'"ie_bytes_o": "$sent_http_x_wit_bytes_origin", '
'"ie_res_o": "$sent_http_x_wit_res_origin", '
'"ie_res": "$sent_http_x_wit_res", '
'"ie_format_o": "$sent_http_x_wit_format_origin", '
'"ie_format": "$sent_http_x_wit_format", '
'"pid": "$pid" '
'}';

# Buffer the access log in RAM, and flush every 10 seconds (not immediately)
access_log /var/log/nginx/revsw_nginx_access_json.log logstash_json flush=10s buffer=256k; 


# Custom access log file in JSON format - CO proxy

log_format logstash_json_co '{'
'"@timestamp": "$time_iso8601", '
'"@version": "1", '
'"conn_id": "$connection", '
'"domain": "$http_host", '
'"ipport": "$server_port", '
'"clientport": "$remote_port", '
'"protocol": "$server_protocol", '
'"clientip": "$remote_addr", '
'"duration": $request_time, '
'"upstream_time": "$upstream_response_time", '
'"response": "$status", '
'"request": "$request_uri", '
'"s_bytes": $bytes_sent, '
'"s_body_bytes": $body_bytes_sent, '
'"r_bytes": $request_length, '
'"method": "$request_method", '
'"conn_status": "$request_completion", '
'"KA": $connection_requests, '
'"x_forwarded_for": "$http_x_forwarded_for", '
'"referer": "$http_referer", '
'"agent": "$http_user_agent", '
'"cont_type": "$sent_http_content_type", '
'"cont_enc": "$sent_http_content_encoding", '
# '"spdy_ver": "$spdy", '
'"tcpinfo_rtt": "$tcpinfo_rtt", '
'"tcpinfo_rttvar": "$tcpinfo_rttvar", '
'"tcpinfo_snd_cwnd": "$tcpinfo_snd_cwnd", '
'"tcpinfo_rcv_space": "$tcpinfo_rcv_space", '
'"pid": "$pid" '
'}';

